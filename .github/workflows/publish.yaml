name: Publish to pub.dev

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

jobs:
  publish:
    permissions:
      id-token: write # Required for authentication using OIDC
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“š Checkout
        uses: actions/checkout@v5

      - name: ğŸ‘´ğŸ¼ Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: ğŸ—’ï¸ Get version from tag name and edit pubspec accordingly
        id: get_version
        run: |
          # Extract version from tag (remove 'v' prefix, support with/without build numbers)
          export VERSION=$(perl -e '$_=$ENV{GITHUB_REF_NAME}//$ENV{GITHUB_REF}//q{}; s/^v//; /(\d+\.\d+\.\d+(?:\+\d+(?:-[A-Za-z0-9.\-]+)?)?)/ or die "Invalid tag format: $_\n"; print $1')
          echo "Extracted version: $VERSION"
          # Update pubspec.yaml version line (replace entire line, no duplication)
          perl -0777 -i -pe 'BEGIN{$v=$ENV{VERSION}} if(s/^version:\s*.*/"version: $v"/em){}else{$_="version: $v\n$_"}' pubspec.yaml
          # Verify update
          if ! grep -q "^version: $VERSION" pubspec.yaml; then
            echo "Error: Failed to update version in pubspec.yaml"
            exit 1
          fi
          echo "Updated pubspec.yaml:"
          grep "^version:" pubspec.yaml

      - name: Publish package
        run: |
          dart pub lish --force
